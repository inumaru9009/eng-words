<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¯ã‚¯ãƒ¯ã‚¯è‹±èªã‚¿ã‚¤ãƒ”ãƒ³ã‚° - å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kiwi Maru', serif;
            background-color: #f0f9ff;
            overflow-x: hidden;
        }
        .bouncy { animation: bounce 0.5s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);} }
        .correct-pop { animation: pop 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
        @keyframes pop { 0%{transform:scale(0.8);}100%{transform:scale(1);} }
        .unit-card { transition: all 0.2s; }
        .unit-card:hover { transform: translateY(-5px); }
        #unit-list::-webkit-scrollbar { width: 8px; }
        #unit-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #unit-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-3xl bg-white rounded-3xl shadow-2xl p-6 md:p-10 relative border-8 border-yellow-300">
        <div id="home-screen" class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-500 mb-2 bouncy">ãˆã„ã”ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ï¼</h1>
            <p id="load-status" class="text-gray-500 mb-4 text-sm">words.json ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...</p>

            <div class="flex justify-center gap-2 mb-6 flex-wrap">
                <button onclick="filterLevel('all')" class="px-4 py-1 bg-blue-100 rounded-full text-xs font-bold hover:bg-blue-200">ã™ã¹ã¦</button>
                <button onclick="filterLevel('elementary')" class="px-4 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold hover:bg-green-200">å°å­¦æ ¡</button>
                <button onclick="filterLevel('junior-high-1')" class="px-4 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold hover:bg-orange-200">ä¸­1</button>
            </div>

            <div id="unit-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8 max-h-[50vh] overflow-y-auto p-2">
                <p class="col-span-full text-gray-400">ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...</p>
            </div>
        </div>

        <div id="mode-selection-screen" class="hidden text-center">
            <button onclick="showHomeScreen()" class="absolute top-4 left-4 text-gray-400 hover:text-blue-500 text-2xl">ğŸ”™</button>
            <div id="level-badge" class="inline-block px-3 py-1 rounded-full text-xs font-bold mb-2"></div>
            <h2 id="selected-unit-title" class="text-2xl font-bold text-gray-700 mb-6 underline decoration-yellow-300">ãƒ¦ãƒ‹ãƒƒãƒˆå</h2>
            <div class="space-y-4 max-w-sm mx-auto">
                <button onclick="startGame('study')" class="w-full py-6 bg-green-400 hover:bg-green-500 text-white rounded-2xl text-xl font-bold shadow-lg border-b-8 border-green-600 transition-all transform hover:scale-105">
                    ğŸ“– ãŒãã—ã‚…ã†ãƒ¢ãƒ¼ãƒ‰<br><span class="text-sm font-normal">ãŠã¦ã»ã‚“ã‚’ ã¿ã¦ ãŠã¼ãˆã‚ˆã†</span>
                </button>
                <button onclick="startGame('test')" class="w-full py-6 bg-orange-400 hover:bg-orange-500 text-white rounded-2xl text-xl font-bold shadow-lg border-b-8 border-orange-600 transition-all transform hover:scale-105">
                    ğŸ”¥ ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰<br><span class="text-sm font-normal">æ—¥æœ¬èªã ã‘ã§ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼</span>
                </button>
            </div>
        </div>

        <div id="game-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <div class="text-lg font-bold text-blue-400"><span id="mode-label" class="mr-2 px-2 py-1 bg-blue-100 rounded text-xs"></span> <span id="current-count">1</span> / <span id="total-count">5</span></div>
                <div class="w-1/2 h-3 bg-gray-200 rounded-full">
                    <div id="progress-bar-fill" class="h-full bg-yellow-400 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <div class="text-center py-8 bg-blue-50 rounded-3xl mb-6 relative border-4 border-blue-100">
                <button onclick="speakWord()" class="absolute top-2 right-2 p-3 bg-white rounded-full shadow-md hover:bg-yellow-100 transition-colors text-xl">ğŸ”Š</button>
                <div id="jp-word" class="text-2xl text-gray-600 font-bold mb-2">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="hint-word" class="text-4xl md:text-5xl text-blue-600 font-bold tracking-widest min-h-[60px] flex justify-center items-center italic">...</div>
            </div>

            <div class="text-center">
                <input type="text" id="typing-input" autocomplete="off" spellcheck="false"
                    class="w-full text-center text-4xl p-4 border-4 border-blue-200 rounded-2xl focus:outline-none focus:border-blue-500 transition-colors uppercase font-mono shadow-inner"
                    placeholder="TYPE HERE">
                <p id="feedback-msg" class="mt-4 text-xl font-bold h-8"></p>
            </div>
        </div>

        <div id="result-screen" class="hidden text-center">
            <h2 class="text-4xl font-bold text-blue-600 mb-6">Good Job!</h2>
            <div class="bg-yellow-50 rounded-3xl p-8 mb-8 border-4 border-yellow-200 shadow-inner">
                <p class="text-xl mb-2" id="result-unit-name">ãƒ¦ãƒ‹ãƒƒãƒˆå</p>
                <div class="text-6xl font-bold text-red-500 mb-4"><span id="score-percent">0</span>%</div>
                <p class="text-gray-600 text-lg">ã›ã„ã‹ã„: <span id="correct-count-display">0</span> / <span id="total-count-display">0</span></p>
            </div>
            <button onclick="showHomeScreen()" class="px-10 py-4 bg-blue-500 text-white rounded-full text-xl font-bold shadow-xl hover:bg-blue-600 transition-all transform hover:scale-110">
                ã¤ãã® ãƒ¦ãƒ‹ãƒƒãƒˆã¸
            </button>
        </div>
    </div>

    <script>
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ï¼ˆå¤–éƒ¨ fetch ãŒå¤±æ•—ã—ãŸå ´åˆã«ä½¿ã†ï¼‰
        const fallbackWords = [
          { "id": 1, "level": "elementary", "name": "ğŸ‘‹ ã‚ã„ã•ã¤ãƒ»è‡ªå·±ç´¹ä»‹", "words":[{"jp":"ã“ã‚“ã«ã¡ã¯","en":"hello"},{"jp":"ãªã¾ãˆ","en":"name"},{"jp":"ã‚ˆã„ãƒ»ã™ã¦ããª","en":"nice"},{"jp":"ã‚ã†","en":"meet"}]},
          { "id": 2, "level": "elementary", "name": "ğŸ¨ æ•°ãƒ»è‰²ãƒ»å½¢", "words":[{"jp":"ï¼‘ã€œï¼’ï¼","en":"one to twenty"},{"jp":"ã‚ã‹","en":"red"},{"jp":"ã‚ãŠ","en":"blue"},{"jp":"ã¾ã‚‹","en":"circle"}]},
          { "id": 3, "level": "elementary", "name": "ğŸ é£Ÿã¹ç‰©ãƒ»æœç‰©", "words":[{"jp":"ã‚Šã‚“ã”","en":"apple"},{"jp":"ã‚«ãƒ¬ãƒ¼","en":"curry"},{"jp":"ã”ã¯ã‚“ãƒ»ãŠç±³","en":"rice"},{"jp":"ç‰›ä¹³","en":"milk"}]},
          { "id": 4, "level": "elementary", "name": "âœï¸ èº«ã®å›ã‚Šã®ç‰©", "words":[{"jp":"ãˆã‚“ã´ã¤","en":"pencil"},{"jp":"æ¶ˆã—ã‚´ãƒ ","en":"eraser"},{"jp":"æœº","en":"desk"},{"jp":"ã‹ã°ã‚“","en":"bag"}]},
          { "id": 5, "level": "elementary", "name": "ğŸ“… æ›œæ—¥ãƒ»æ™‚é–“", "words":[{"jp":"æ—¥æ›œæ—¥","en":"Sunday"},{"jp":"æœˆæ›œæ—¥","en":"Monday"},{"jp":"ã€œæ™‚","en":"o'clock"}]},
          { "id": 6, "level": "elementary", "name": "ğŸƒ å‹•ä½œãƒ»æ—¥èª²", "words":[{"jp":"èµ·ãã‚‹","en":"get up"},{"jp":"å¯ã‚‹","en":"go to bed"},{"jp":"æ´—ã†","en":"wash"}]},
          { "id": 7, "level": "elementary", "name": "ğŸ« æ•™ç§‘ãƒ»å­¦æ ¡", "words":[{"jp":"æ•°å­¦","en":"math"},{"jp":"ç†ç§‘","en":"science"},{"jp":"ä½“è‚²é¤¨","en":"gym"},{"jp":"å…ˆç”Ÿ","en":"teacher"}]},
          { "id": 8, "level": "elementary", "name": "ğŸ‘¨â€âš•ï¸ å°†æ¥ã®å¤¢ãƒ»è·æ¥­", "words":[{"jp":"åŒ»è€…","en":"doctor"},{"jp":"ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆ","en":"pilot"},{"jp":"ã€œã«ãªã‚ŠãŸã„","en":"want to be"}]},
          { "id": 9, "level": "elementary", "name": "ğŸ“œ éå»ã®çµŒé¨“", "words":[{"jp":"è¡Œã£ãŸ","en":"went"},{"jp":"é£Ÿã¹ãŸ","en":"ate"},{"jp":"æ¥½ã—ã‚“ã ","en":"enjoyed"},{"jp":"æŒã£ã¦ã„ãŸãƒ»ã—ãŸ","en":"had"}]}
        ];

        let userProgress = { studyCleared: [], testCleared: [] };
        let units = [];
        let currentUnit = null;
        let currentMode = 'study';
        let currentIndex = 0;
        let corrects = 0;
        let sessionWords = [];
        let currentLevelFilter = 'all';

        const screens = {
            home: document.getElementById('home-screen'),
            mode: document.getElementById('mode-selection-screen'),
            game: document.getElementById('game-screen'),
            result: document.getElementById('result-screen')
        };

        async function loadWords() {
            const statusEl = document.getElementById('load-status');
            const tryPaths = [
                'words.json',
                './words.json',
                window.location.pathname.replace(/\/[^/]*$/, '/words.json'),
                new URL('words.json', window.location.href).href
            ];

            statusEl.textContent = 'words.json ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...';
            for (const p of tryPaths) {
                try {
                    console.log('Trying to fetch words.json from:', p);
                    const response = await fetch(p, {cache: "no-store"});
                    if (!response.ok) { console.warn('Fetch response not OK for', p, response.status); continue; }
                    const data = await response.json();
                    units = data;
                    statusEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ';
                    renderUnits();
                    return;
                } catch (err) {
                    console.warn('Fetch failed for', p, err);
                }
            }

            console.error('Failed to load words.json from network; using built-in fallback data.');
            document.getElementById('unit-list').innerHTML = '';
            units = fallbackWords;
            statusEl.textContent = 'è­¦å‘Š: å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†…è”µãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ï¼ˆå…¬é–‹æ™‚ã¯ words.json ã‚’ãƒ«ãƒ¼ãƒˆã«ç½®ã„ã¦ãã ã•ã„ï¼‰ã€‚';
            renderUnits();
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        function filterLevel(level) { currentLevelFilter = level; renderUnits(); }

        function renderUnits() {
            const container = document.getElementById('unit-list');
            container.innerHTML = '';
            const filteredUnits = units.filter(u => currentLevelFilter === 'all' || u.level === currentLevelFilter);
            filteredUnits.forEach(unit => {
                const isStudyCleared = userProgress.studyCleared.includes(unit.id);
                const isTestCleared = userProgress.testCleared.includes(unit.id);
                const card = document.createElement('div');
                let levelColor = "bg-green-100 text-green-700";
                if(unit.level.includes("1")) levelColor = "bg-orange-100 text-orange-700";
                card.className = `unit-card p-4 rounded-2xl border-4 cursor-pointer text-left bg-white ${isTestCleared ? 'border-yellow-400' : 'border-blue-100'}`;
                card.onclick = () => selectUnit(unit);
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold ${levelColor}">${getLevelLabel(unit.level)}</span>
                        <div class="flex gap-1 text-sm">${isStudyCleared ? 'ğŸ“–' : ''}${isTestCleared ? 'ğŸ”¥' : ''}</div>
                    </div>
                    <span class="font-bold text-gray-700 block text-sm sm:text-base">${unit.name}</span>
                `;
                container.appendChild(card);
            });
        }

        function getLevelLabel(level) {
            switch(level) { case 'elementary': return 'å°å­¦æ ¡'; case 'junior-high-1': return 'ä¸­1'; default: return level; }
        }

        function selectUnit(unit) {
            currentUnit = unit;
            document.getElementById('selected-unit-title').textContent = unit.name;
            const badge = document.getElementById('level-badge');
            badge.textContent = getLevelLabel(unit.level);
            badge.className = "inline-block px-3 py-1 rounded-full text-xs font-bold mb-2 ";
            if(unit.level === 'elementary') badge.classList.add('bg-green-100', 'text-green-700');
            else badge.classList.add('bg-orange-100', 'text-orange-700');
            showScreen('mode');
        }

        function showHomeScreen() { renderUnits(); showScreen('home'); }

        function startGame(mode) {
            currentMode = mode; currentIndex = 0; corrects = 0;
            sessionWords = [...currentUnit.words];
            if (mode === 'test') sessionWords.sort(() => 0.5 - Math.random());
            document.getElementById('mode-label').textContent = mode === 'study' ? 'ãŒãã—ã‚…ã†' : 'ãƒ†ã‚¹ãƒˆ';
            document.getElementById('total-count').textContent = sessionWords.length;
            showScreen('game'); updateWord(); document.getElementById('typing-input').focus();
        }

        function updateWord() {
            const word = sessionWords[currentIndex];
            document.getElementById('jp-word').textContent = word.jp;
            document.getElementById('hint-word').textContent = currentMode === 'study' ? word.en : "_ ".repeat(word.en.length).trim();
            document.getElementById('current-count').textContent = currentIndex + 1;
            document.getElementById('progress-bar-fill').style.width = `${((currentIndex) / sessionWords.length) * 100}%`;
            document.getElementById('typing-input').value = "";
            document.getElementById('typing-input').disabled = false;
            document.getElementById('feedback-msg').textContent = "";
            speakWord();
        }

        function speakWord() {
            const word = sessionWords[currentIndex].en;
            const uttr = new SpeechSynthesisUtterance(word);
            uttr.lang = 'en-US'; uttr.rate = 0.8;
            speechSynthesis.speak(uttr);
        }

        document.getElementById('typing-input').addEventListener('input', (e) => {
            const target = sessionWords[currentIndex].en.toLowerCase();
            const input = e.target.value.toLowerCase();
            if (input === target) handleCorrect();
            else if (input.length > 0 && !target.startsWith(input)) handleError();
        });

        function handleCorrect() {
            corrects++;
            document.getElementById('feedback-msg').textContent = "âœ¨ Correct! âœ¨";
            document.getElementById('feedback-msg').className = "mt-4 text-xl font-bold text-green-500 correct-pop";
            document.getElementById('typing-input').disabled = true;
            const uttr = new SpeechSynthesisUtterance(sessionWords[currentIndex].en);
            uttr.lang = 'en-US'; speechSynthesis.speak(uttr);
            setTimeout(() => {
                currentIndex++;
                if (currentIndex < sessionWords.length) { updateWord(); document.getElementById('typing-input').focus(); }
                else showResult();
            }, 800);
        }

        function handleError() {
            const input = document.getElementById('typing-input');
            input.classList.add('shake');
            document.getElementById('feedback-msg').textContent = "Oops!";
            document.getElementById('feedback-msg').className = "mt-4 text-xl font-bold text-red-500";
            setTimeout(() => input.classList.remove('shake'), 500);
        }

        function showResult() {
            if (currentMode === 'study') {
                if (!userProgress.studyCleared.includes(currentUnit.id)) userProgress.studyCleared.push(currentUnit.id);
            } else {
                if (corrects === sessionWords.length && !userProgress.testCleared.includes(currentUnit.id)) userProgress.testCleared.push(currentUnit.id);
            }
            document.getElementById('result-unit-name').textContent = currentUnit.name;
            const percent = Math.round((corrects / sessionWords.length) * 100);
            document.getElementById('score-percent').textContent = percent;
            document.getElementById('correct-count-display').textContent = corrects;
            document.getElementById('total-count-display').textContent = sessionWords.length;
            showScreen('result');
        }

        window.onload = () => { loadWords(); };
    </script>
</body>
</html>
