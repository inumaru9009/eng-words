<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÉØ„ÇØ„ÉØ„ÇØËã±Ë™û„Çø„Ç§„Éî„É≥„Ç∞ - „Ç≠„ÉÉ„Ç∫„Çµ„Éù„Éº„ÉàÁâà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Andika&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kiwi Maru', serif;
            background-color: #f0f9ff;
            overflow-x: hidden;
            user-select: none;
        }
        .typing-font {
            font-family: 'Andika', sans-serif;
        }
        .key-guide {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            background: white;
            font-weight: bold;
            transition: all 0.1s;
        }
        .key-active {
            background-color: #fde047;
            border-color: #eab308;
            transform: translateY(2px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .bouncy {
            animation: bounce 0.5s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-4xl mx-auto flex justify-end gap-4 mb-4">
        <label class="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm cursor-pointer border-2 border-blue-200">
            <input type="checkbox" id="case-toggle" class="w-5 h-5" onchange="toggleCase()">
            <span class="text-sm font-bold text-blue-800">Â§ßÊñáÂ≠ó„Å´„Åô„Çã (A B C)</span>
        </label>
    </div>

    <div id="app" class="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden min-h-[600px] relative border-8 border-yellow-300">
        
        <div id="screen-start" class="p-8 text-center">
            <h1 class="text-5xl font-bold text-blue-600 mb-4 bouncy mt-10">„ÉØ„ÇØ„ÉØ„ÇØ„Åà„ÅÑ„Åî„Çø„Ç§„Éî„É≥„Ç∞</h1>
            <p class="text-gray-500 mb-8 text-xl">„Åô„Åç„Å™„Ç≥„Éº„Çπ„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ</p>
            <div id="unit-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[400px] overflow-y-auto p-2">
                <p id="loading-msg" class="text-center col-span-2">„Çà„Åø„Åì„Åø„Å°„ÇÖ„ÅÜ...</p>
            </div>
        </div>

        <div id="screen-play" class="hidden p-8">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showScreen('start')" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-xl font-bold text-gray-700">‚Üê „ÇÇ„Å©„Çã</button>
                <div id="progress-bar-container" class="flex-1 mx-8 bg-gray-100 h-6 rounded-full overflow-hidden border-2 border-gray-200">
                    <div id="progress-bar" class="bg-green-400 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div id="timer" class="text-2xl font-bold text-blue-500 w-16"></div>
            </div>

            <div class="text-center py-10">
                <div id="jp-display" class="text-3xl text-gray-500 mb-2"></div>
                <div class="flex items-center justify-center gap-4 mb-10">
                    <div id="en-display" class="text-7xl font-bold tracking-widest typing-font text-blue-900"></div>
                    <button onclick="speakCurrentWord()" class="bg-blue-100 hover:bg-blue-200 p-3 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                    </button>
                </div>
                
                <input type="text" id="typing-input" class="absolute opacity-0 pointer-events-none" autocomplete="off">
                <div id="input-guide" class="text-xl text-gray-400">„Ç≠„Éº„Éú„Éº„Éâ„Åß „ÅÜ„Å£„Å¶„Åø„Çà„ÅÜÔºÅ</div>
                <div id="feedback-msg" class="h-8 mt-4 font-bold"></div>
            </div>

            <div id="keyboard-guide" class="mt-8 flex flex-col items-center gap-1 opacity-80">
                <div class="flex gap-1" id="row-1"></div>
                <div class="flex gap-1 mt-1" id="row-2"></div>
                <div class="flex gap-1 mt-1" id="row-3"></div>
            </div>
        </div>

        <div id="screen-result" class="hidden p-12 text-center">
            <h2 class="text-4xl font-bold text-yellow-500 mb-6">„Åä„Çè„Å£„Åü„ÇàÔºÅ</h2>
            <div class="text-6xl font-bold mb-4"><span id="score-percent">0</span>%</div>
            <p id="result-unit-name" class="text-2xl text-gray-600 mb-8"></p>
            <div class="bg-blue-50 p-6 rounded-2xl mb-8 flex justify-around">
                <div>
                    <div class="text-gray-500">„Åõ„ÅÑ„Åã„ÅÑ</div>
                    <div class="text-3xl font-bold text-blue-600"><span id="correct-count-display">0</span> / <span id="total-count-display">0</span></div>
                </div>
            </div>
            <button onclick="showScreen('start')" class="bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold px-12 py-4 rounded-2xl shadow-lg transition-transform active:scale-95">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÔºÅ</button>
        </div>
    </div>

    <script>
        let allData = [];
        let currentUnit = null;
        let sessionWords = [];
        let currentWordIndex = 0;
        let corrects = 0;
        let isUpperCase = false;

        const ROWS = [
            "QWERTYUIOP",
            "ASDFGHJKL",
            "ZXCVBNM"
        ];

        const fallbackData = [
            {
                "id": 1,
                "name": "üçé „Åü„Åπ„ÇÇ„ÅÆ (Sample)",
                "words": [
                    { "en": "apple", "jp": "„Çä„Çì„Åî" },
                    { "en": "banana", "jp": "„Éê„Éä„Éä" },
                    { "en": "orange", "jp": "„Ç™„É¨„É≥„Ç∏" }
                ]
            }
        ];

        // Èü≥Â£∞Ë™≠„Åø‰∏ä„ÅíÈñ¢Êï∞
        function speak(text) {
            if (!window.speechSynthesis) return;
            // Ââç„ÅÆÈü≥Â£∞„Çí„Ç≠„É£„É≥„Çª„É´
            window.speechSynthesis.cancel();
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'en-US';
            uttr.rate = 0.9; // Â∞ë„Åó„ÇÜ„Å£„Åè„Çä„ÇÅ„Å´ÂÜçÁîü
            window.speechSynthesis.speak(uttr);
        }

        function speakCurrentWord() {
            if (sessionWords[currentWordIndex]) {
                speak(sessionWords[currentWordIndex].en);
            }
        }

        async function loadWords() {
            try {
                const response = await fetch('words.json').catch(() => fetch('./words.json'));
                if (!response.ok) throw new Error('Fetch failed');
                allData = await response.json();
            } catch (error) {
                console.warn("Using fallback data due to fetch error:", error);
                allData = fallbackData;
            } finally {
                renderUnitList();
                createKeyboard();
            }
        }

        function createKeyboard() {
            ROWS.forEach((row, i) => {
                const container = document.getElementById(`row-${i+1}`);
                if (!container) return;
                container.innerHTML = '';
                row.split('').forEach(char => {
                    const div = document.createElement('div');
                    div.id = `key-${char}`;
                    div.className = 'key-guide text-sm';
                    div.textContent = char;
                    container.appendChild(div);
                });
            });
        }

        function toggleCase() {
            isUpperCase = document.getElementById('case-toggle').checked;
            if (currentUnit) updateWordDisplay();
        }

        function renderUnitList() {
            const list = document.getElementById('unit-list');
            if (!list) return;
            list.innerHTML = '';
            
            const loadingMsg = document.getElementById('loading-msg');
            if (loadingMsg) loadingMsg.style.display = 'none';

            allData.forEach(unit => {
                const btn = document.createElement('button');
                btn.className = "bg-white border-4 border-blue-100 hover:border-blue-400 p-6 rounded-2xl shadow-sm text-left transition-all hover:scale-[1.02] flex items-center justify-between";
                btn.innerHTML = `
                    <div>
                        <div class="text-2xl mb-1">${unit.name}</div>
                        <div class="text-gray-400 text-sm">${unit.words.length} ÂçòË™û</div>
                    </div>
                    <div class="text-blue-300 text-3xl">‚ñ∂</div>
                `;
                btn.onclick = () => startSession(unit);
                list.appendChild(btn);
            });
        }

        function showScreen(screenId) {
            ['start', 'play', 'result'].forEach(id => {
                const el = document.getElementById(`screen-${id}`);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(`screen-${screenId}`);
            if (target) target.classList.remove('hidden');
            
            if (screenId === 'play') {
                setTimeout(() => {
                    const input = document.getElementById('typing-input');
                    if (input) input.focus();
                }, 100);
            }
        }

        function startSession(unit) {
            currentUnit = unit;
            sessionWords = [...unit.words].sort(() => Math.random() - 0.5).slice(0, 10);
            currentWordIndex = 0;
            corrects = 0;
            showScreen('play');
            nextWord();
        }

        function nextWord() {
            if (currentWordIndex >= sessionWords.length) {
                showResult();
                return;
            }
            updateWordDisplay();
            const input = document.getElementById('typing-input');
            if (input) {
                input.value = '';
                input.focus();
            }
            const progress = document.getElementById('progress-bar');
            if (progress) progress.style.width = `${(currentWordIndex / sessionWords.length) * 100}%`;
            highlightNextKey();
            
            // ÂçòË™û„ÅåË°®Á§∫„Åï„Çå„ÅüÁû¨Èñì„Å´Ë™≠„Åø‰∏ä„Åí
            speakCurrentWord();
        }

        function updateWordDisplay() {
            const word = sessionWords[currentWordIndex];
            if (!word) return;
            document.getElementById('jp-display').textContent = word.jp;
            const targetEn = isUpperCase ? word.en.toUpperCase() : word.en.toLowerCase();
            document.getElementById('en-display').textContent = targetEn;
        }

        function highlightNextKey() {
            document.querySelectorAll('.key-guide').forEach(k => k.classList.remove('key-active'));
            if (!sessionWords[currentWordIndex]) return;
            const targetWord = sessionWords[currentWordIndex].en.toUpperCase();
            const input = document.getElementById('typing-input');
            const currentTyped = input ? input.value.toUpperCase() : "";
            if (currentTyped.length < targetWord.length) {
                const nextChar = targetWord[currentTyped.length].replace(/[^A-Z]/g, '');
                if (nextChar) {
                    const keyEl = document.getElementById(`key-${nextChar}`);
                    if (keyEl) keyEl.classList.add('key-active');
                }
            }
        }

        const typingInput = document.getElementById('typing-input');
        if (typingInput) {
            typingInput.addEventListener('input', (e) => {
                if (!sessionWords[currentWordIndex]) return;
                const word = sessionWords[currentWordIndex].en.toLowerCase();
                const val = e.target.value.toLowerCase();
                if (word.startsWith(val)) {
                    document.getElementById('feedback-msg').textContent = "";
                    highlightNextKey();
                    if (val === word) {
                        corrects++;
                        currentWordIndex++;
                        setTimeout(nextWord, 150);
                    }
                } else {
                    handleError();
                    e.target.value = val.slice(0, -1);
                }
            });
        }

        document.addEventListener('click', () => {
            const input = document.getElementById('typing-input');
            if (input && !document.getElementById('screen-play').classList.contains('hidden')) {
                input.focus();
            }
        });

        function handleError() {
            const display = document.getElementById('en-display');
            if (display) display.classList.add('shake');
            const feedback = document.getElementById('feedback-msg');
            if (feedback) {
                feedback.textContent = "„Åä„Åó„ÅÑÔºÅ";
                feedback.className = "h-8 mt-4 text-xl font-bold text-red-500";
            }
            setTimeout(() => {
                if (display) display.classList.remove('shake');
            }, 500);
        }

        function showResult() {
            if (!currentUnit) return;
            document.getElementById('result-unit-name').textContent = currentUnit.name;
            const percent = Math.round((corrects / sessionWords.length) * 100);
            document.getElementById('score-percent').textContent = percent;
            document.getElementById('correct-count-display').textContent = corrects;
            document.getElementById('total-count-display').textContent = sessionWords.length;
            showScreen('result');
            // ÁµÇ‰∫ÜÊôÇ„Å´„ÅäÁ•ù„ÅÑÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
            speak("Wonderful! You did it!");
        }

        window.onload = loadWords;
    </script>
</body>
</html>