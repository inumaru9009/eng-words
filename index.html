<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„ÉØ„ÇØ„ÉØ„ÇØËã±Ë™û„Çø„Ç§„Éî„É≥„Ç∞ - „Ç≠„ÉÉ„Ç∫„Çµ„Éù„Éº„ÉàÁâà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kiwi+Maru:wght@400;500&family=Andika&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kiwi Maru', serif;
            background-color: #f0f9ff;
            overflow-x: hidden;
            user-select: none;
        }
        .typing-font {
            font-family: 'Andika', sans-serif;
        }
        .key-guide {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            background: white;
            font-weight: bold;
            transition: all 0.1s;
        }
        .key-active {
            background-color: #fde047;
            border-color: #eab308;
            transform: translateY(2px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .bouncy {
            animation: bounce 0.5s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
        .shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .monster-damage {
            animation: damage 0.3s;
        }
        @keyframes damage {
            0% { transform: scale(1) rotate(0deg); filter: brightness(1); }
            50% { transform: scale(0.8) rotate(10deg); filter: brightness(2) sepia(1); }
            100% { transform: scale(1) rotate(0deg); filter: brightness(1); }
        }
        .combo-pop {
            animation: combo 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes combo {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-4xl mx-auto flex justify-between items-center mb-4">
        <div class="bg-white px-6 py-2 rounded-full shadow-md border-2 border-blue-200">
            <span class="text-blue-800 font-bold">LV. <span id="user-level">1</span></span>
            <div class="inline-block w-24 h-3 bg-gray-200 rounded-full ml-2 overflow-hidden">
                <div id="level-bar" class="bg-blue-400 h-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>
        <label class="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm cursor-pointer border-2 border-blue-200">
            <input type="checkbox" id="case-toggle" class="w-5 h-5" onchange="toggleCase()">
            <span class="text-sm font-bold text-blue-800">Â§ßÊñáÂ≠ó„Å´„Åô„Çã (A B C)</span>
        </label>
    </div>

    <div id="app" class="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden min-h-[600px] relative border-8 border-yellow-300">
        
        <div id="screen-start" class="p-8 text-center">
            <h1 class="text-5xl font-bold text-blue-600 mb-4 bouncy mt-10">„ÉØ„ÇØ„ÉØ„ÇØ„Åà„ÅÑ„Åî„Çø„Ç§„Éî„É≥„Ç∞</h1>
            <p class="text-gray-500 mb-8 text-xl">„Åô„Åç„Å™„Ç≥„Éº„Çπ„Çí„Åà„Çâ„Çì„Åß„Å≠ÔºÅ</p>
            <div id="unit-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[400px] overflow-y-auto p-2">
                <p id="loading-msg" class="text-center col-span-2">„Çà„Åø„Åì„Åø„Å°„ÇÖ„ÅÜ...</p>
            </div>
        </div>

        <div id="screen-play" class="hidden p-8">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showScreen('start')" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-xl font-bold text-gray-700">‚Üê „ÇÇ„Å©„Çã</button>
                <div id="progress-bar-container" class="flex-1 mx-8 bg-gray-100 h-6 rounded-full overflow-hidden border-2 border-gray-200">
                    <div id="progress-bar" class="bg-green-400 h-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <div class="flex items-center gap-2">
                    <span id="combo-display" class="hidden text-orange-500 font-black text-2xl combo-pop">0 COMBO!</span>
                </div>
            </div>

            <div class="text-center py-4">
                <!-- „É¢„É≥„Çπ„Çø„ÉºÊºîÂá∫„Ç®„É™„Ç¢ -->
                <div class="relative h-32 flex justify-center items-center mb-4">
                    <div id="monster" class="text-6xl transition-all duration-300">üëæ</div>
                    <div id="damage-effect" class="absolute text-red-500 font-bold text-2xl opacity-0 pointer-events-none">HIT!</div>
                </div>

                <div id="jp-display" class="text-3xl text-gray-500 mb-2"></div>
                <div class="flex items-center justify-center gap-4 mb-6">
                    <div id="en-display" class="text-7xl font-bold tracking-widest typing-font text-blue-900"></div>
                    <button onclick="speakCurrentWord()" class="bg-blue-100 hover:bg-blue-200 p-3 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                    </button>
                </div>
                
                <input type="text" id="typing-input" class="absolute opacity-0 pointer-events-none" autocomplete="off">
                <div id="input-guide" class="text-xl text-gray-400">„Ç≠„Éº„Éú„Éº„Éâ„Åß „ÅÜ„Å£„Å¶„Åø„Çà„ÅÜÔºÅ</div>
                <div id="feedback-msg" class="h-8 mt-4 font-bold"></div>
            </div>

            <div id="keyboard-guide" class="mt-4 flex flex-col items-center gap-1 opacity-80">
                <div class="flex gap-1" id="row-1"></div>
                <div class="flex gap-1 mt-1" id="row-2"></div>
                <div class="flex gap-1 mt-1" id="row-3"></div>
            </div>
        </div>

        <div id="screen-result" class="hidden p-12 text-center">
            <h2 class="text-4xl font-bold text-yellow-500 mb-2">„Åä„Çè„Å£„Åü„ÇàÔºÅ</h2>
            <div id="rank-display" class="text-8xl font-black text-orange-500 mb-6 italic">A</div>
            <div class="text-4xl font-bold mb-4"><span id="score-percent">0</span>%</div>
            <p id="result-unit-name" class="text-2xl text-gray-600 mb-8"></p>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-2xl">
                    <div class="text-gray-500">„Åõ„ÅÑ„Åã„ÅÑ</div>
                    <div class="text-2xl font-bold text-blue-600"><span id="correct-count-display">0</span> / <span id="total-count-display">0</span></div>
                </div>
                <div class="bg-orange-50 p-4 rounded-2xl">
                    <div class="text-gray-500">„Åï„ÅÑ„Å†„ÅÑ„Ç≥„É≥„Éú</div>
                    <div class="text-2xl font-bold text-orange-600"><span id="max-combo-display">0</span></div>
                </div>
            </div>

            <div id="exp-area" class="mb-8 hidden">
                <div class="text-sm font-bold text-blue-800 mb-1">„Åë„ÅÑ„Åë„Çì„Å° „Åã„Åè„Å®„ÅèÔºÅ</div>
                <div class="w-full h-4 bg-gray-200 rounded-full overflow-hidden">
                    <div id="result-exp-bar" class="bg-blue-400 h-full transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>

            <button onclick="showScreen('start')" class="bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold px-12 py-4 rounded-2xl shadow-lg transition-transform active:scale-95">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©ÔºÅ</button>
        </div>
    </div>

    <script>
        let allData = [];
        let currentUnit = null;
        let sessionWords = [];
        let currentWordIndex = 0;
        let corrects = 0;
        let combo = 0;
        let maxCombo = 0;
        let isUpperCase = false;

        // „É¶„Éº„Ç∂„Éº„ÅÆÊàêÈï∑„Éá„Éº„ÇøÔºàÊú¨Êù•„ÅØlocalStorage„Å™„Å©„Åß‰øùÂ≠ò„Åô„Çã„Å®„Çà„ÇäËâØ„ÅÑÔºâ
        let userStats = {
            level: 1,
            exp: 0,
            neededExp: 100
        };

        const MONSTERS = ["üëæ", "üêâ", "üëª", "üëπ", "ü§ñ", "üõ∏", "üéÉ"];

        const ROWS = [
            "QWERTYUIOP",
            "ASDFGHJKL",
            "ZXCVBNM"
        ];

        const fallbackData = [
            {
                "id": 1,
                "name": "üçé „Åü„Åπ„ÇÇ„ÅÆ (Sample)",
                "words": [
                    { "en": "apple", "jp": "„Çä„Çì„Åî" },
                    { "en": "banana", "jp": "„Éê„Éä„Éä" },
                    { "en": "orange", "jp": "„Ç™„É¨„É≥„Ç∏" },
                    { "en": "grape", "jp": "„Å∂„Å©„ÅÜ" },
                    { "en": "melon", "jp": "„ÇÅ„Çç„Çì" }
                ]
            }
        ];

        function speak(text) {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const uttr = new SpeechSynthesisUtterance(text);
            uttr.lang = 'en-US';
            uttr.rate = 0.9;
            window.speechSynthesis.speak(uttr);
        }

        function speakCurrentWord() {
            if (sessionWords[currentWordIndex]) {
                speak(sessionWords[currentWordIndex].en);
            }
        }

        async function loadWords() {
            try {
                const response = await fetch('words.json').catch(() => fetch('./words.json'));
                if (!response.ok) throw new Error('Fetch failed');
                allData = await response.json();
            } catch (error) {
                console.warn("Using fallback data due to fetch error:", error);
                allData = fallbackData;
            } finally {
                renderUnitList();
                createKeyboard();
                updateLevelUI();
            }
        }

        function updateLevelUI() {
            document.getElementById('user-level').textContent = userStats.level;
            const progress = (userStats.exp / userStats.neededExp) * 100;
            document.getElementById('level-bar').style.width = `${progress}%`;
        }

        function createKeyboard() {
            ROWS.forEach((row, i) => {
                const container = document.getElementById(`row-${i+1}`);
                if (!container) return;
                container.innerHTML = '';
                row.split('').forEach(char => {
                    const div = document.createElement('div');
                    div.id = `key-${char}`;
                    div.className = 'key-guide text-sm';
                    div.textContent = char;
                    container.appendChild(div);
                });
            });
        }

        function toggleCase() {
            isUpperCase = document.getElementById('case-toggle').checked;
            if (currentUnit) updateWordDisplay();
        }

        function renderUnitList() {
            const list = document.getElementById('unit-list');
            if (!list) return;
            list.innerHTML = '';
            
            const loadingMsg = document.getElementById('loading-msg');
            if (loadingMsg) loadingMsg.style.display = 'none';

            allData.forEach(unit => {
                const btn = document.createElement('button');
                btn.className = "bg-white border-4 border-blue-100 hover:border-blue-400 p-6 rounded-2xl shadow-sm text-left transition-all hover:scale-[1.02] flex items-center justify-between";
                btn.innerHTML = `
                    <div>
                        <div class="text-2xl mb-1">${unit.name}</div>
                        <div class="text-gray-400 text-sm">${unit.words.length} ÂçòË™û</div>
                    </div>
                    <div class="text-blue-300 text-3xl">‚ñ∂</div>
                `;
                btn.onclick = () => startSession(unit);
                list.appendChild(btn);
            });
        }

        function showScreen(screenId) {
            ['start', 'play', 'result'].forEach(id => {
                const el = document.getElementById(`screen-${id}`);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(`screen-${screenId}`);
            if (target) target.classList.remove('hidden');
            
            if (screenId === 'play') {
                setTimeout(() => {
                    const input = document.getElementById('typing-input');
                    if (input) input.focus();
                }, 100);
            }
        }

        function startSession(unit) {
            currentUnit = unit;
            sessionWords = [...unit.words].sort(() => Math.random() - 0.5).slice(0, 10);
            currentWordIndex = 0;
            corrects = 0;
            combo = 0;
            maxCombo = 0;
            // „É¢„É≥„Çπ„Çø„Éº„Çí„É©„É≥„ÉÄ„É†„Å´ÈÅ∏„Å∂
            document.getElementById('monster').textContent = MONSTERS[Math.floor(Math.random() * MONSTERS.length)];
            showScreen('play');
            nextWord();
        }

        function nextWord() {
            if (currentWordIndex >= sessionWords.length) {
                showResult();
                return;
            }
            updateWordDisplay();
            const input = document.getElementById('typing-input');
            if (input) {
                input.value = '';
                input.focus();
            }
            const progress = document.getElementById('progress-bar');
            if (progress) progress.style.width = `${(currentWordIndex / sessionWords.length) * 100}%`;
            highlightNextKey();
            speakCurrentWord();
        }

        function updateWordDisplay() {
            const word = sessionWords[currentWordIndex];
            if (!word) return;
            document.getElementById('jp-display').textContent = word.jp;
            const targetEn = isUpperCase ? word.en.toUpperCase() : word.en.toLowerCase();
            document.getElementById('en-display').textContent = targetEn;
        }

        function highlightNextKey() {
            document.querySelectorAll('.key-guide').forEach(k => k.classList.remove('key-active'));
            if (!sessionWords[currentWordIndex]) return;
            const targetWord = sessionWords[currentWordIndex].en.toUpperCase();
            const input = document.getElementById('typing-input');
            const currentTyped = input ? input.value.toUpperCase() : "";
            if (currentTyped.length < targetWord.length) {
                const nextChar = targetWord[currentTyped.length].replace(/[^A-Z]/g, '');
                if (nextChar) {
                    const keyEl = document.getElementById(`key-${nextChar}`);
                    if (keyEl) keyEl.classList.add('key-active');
                }
            }
        }

        const typingInput = document.getElementById('typing-input');
        if (typingInput) {
            typingInput.addEventListener('input', (e) => {
                if (!sessionWords[currentWordIndex]) return;
                const word = sessionWords[currentWordIndex].en.toLowerCase();
                const val = e.target.value.toLowerCase();
                
                if (word.startsWith(val)) {
                    document.getElementById('feedback-msg').textContent = "";
                    highlightNextKey();
                    if (val === word) {
                        handleCorrect();
                    }
                } else {
                    handleError();
                    e.target.value = val.slice(0, -1);
                }
            });
        }

        function handleCorrect() {
            corrects++;
            combo++;
            if (combo > maxCombo) maxCombo = combo;
            
            // „Ç≥„É≥„ÉúË°®Á§∫
            const comboEl = document.getElementById('combo-display');
            if (combo >= 2) {
                comboEl.textContent = `${combo} COMBO!`;
                comboEl.classList.remove('hidden', 'combo-pop');
                void comboEl.offsetWidth; // reflow
                comboEl.classList.add('combo-pop');
            }

            // „É¢„É≥„Çπ„Çø„Éº„ÉÄ„É°„Éº„Ç∏ÊºîÂá∫
            const monster = document.getElementById('monster');
            monster.classList.remove('monster-damage');
            void monster.offsetWidth;
            monster.classList.add('monster-damage');
            
            const damage = document.getElementById('damage-effect');
            damage.style.opacity = "1";
            damage.style.transform = "translateY(-20px)";
            setTimeout(() => {
                damage.style.opacity = "0";
                damage.style.transform = "translateY(0)";
            }, 300);

            currentWordIndex++;
            setTimeout(nextWord, 150);
        }

        document.addEventListener('click', () => {
            const input = document.getElementById('typing-input');
            if (input && !document.getElementById('screen-play').classList.contains('hidden')) {
                input.focus();
            }
        });

        function handleError() {
            combo = 0;
            document.getElementById('combo-display').classList.add('hidden');
            
            const display = document.getElementById('en-display');
            if (display) display.classList.add('shake');
            const feedback = document.getElementById('feedback-msg');
            if (feedback) {
                feedback.textContent = "„Åä„Åó„ÅÑÔºÅ";
                feedback.className = "h-8 mt-4 text-xl font-bold text-red-500";
            }
            setTimeout(() => {
                if (display) display.classList.remove('shake');
            }, 500);
        }

        function showResult() {
            if (!currentUnit) return;
            document.getElementById('result-unit-name').textContent = currentUnit.name;
            const percent = Math.round((corrects / sessionWords.length) * 100);
            document.getElementById('score-percent').textContent = percent;
            document.getElementById('correct-count-display').textContent = corrects;
            document.getElementById('total-count-display').textContent = sessionWords.length;
            document.getElementById('max-combo-display').textContent = maxCombo;

            // „É©„É≥„ÇØÂà§ÂÆö
            let rank = "C";
            let color = "text-gray-400";
            if (percent >= 100) { rank = "S"; color = "text-yellow-500"; }
            else if (percent >= 80) { rank = "A"; color = "text-orange-500"; }
            else if (percent >= 60) { rank = "B"; color = "text-blue-500"; }
            
            const rankEl = document.getElementById('rank-display');
            rankEl.textContent = rank;
            rankEl.className = `text-8xl font-black mb-6 italic ${color} combo-pop`;

            // ÁµåÈ®ìÂÄ§Âá¶ÁêÜ
            document.getElementById('exp-area').classList.remove('hidden');
            addExp(percent * 2 + maxCombo * 5);

            showScreen('result');
            
            if (percent === 100) {
                speak("Amazing! Perfect score!");
            } else {
                speak("Wonderful! You did it!");
            }
        }

        function addExp(amount) {
            userStats.exp += amount;
            if (userStats.exp >= userStats.neededExp) {
                userStats.level++;
                userStats.exp -= userStats.neededExp;
                userStats.neededExp = Math.floor(userStats.neededExp * 1.2);
                setTimeout(() => speak("Level Up!"), 1000);
            }
            updateLevelUI();
            
            // „É™„Ç∂„É´„ÉàÁîªÈù¢„ÅÆ„Éê„Éº„ÇÇÊõ¥Êñ∞
            const resBar = document.getElementById('result-exp-bar');
            resBar.style.width = "0%";
            setTimeout(() => {
                resBar.style.width = `${(userStats.exp / userStats.neededExp) * 100}%`;
            }, 100);
        }

        window.onload = loadWords;
    </script>
</body>
</html>